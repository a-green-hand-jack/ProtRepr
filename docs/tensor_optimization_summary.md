# Atom14 å¼ é‡ä¼˜åŒ–æ€»ç»“æŠ¥å‘Š

**ä¼˜åŒ–æ—¥æœŸ**: 2025-01-26  
**é¡¹ç›®**: ProtRepr - Atom14 è¡¨ç¤ºè½¬æ¢å™¨  
**ç›®æ ‡**: å‡å°‘ Python å¾ªç¯ï¼Œä½¿ç”¨ PyTorch åŸç”Ÿæ“ä½œæå‡æ€§èƒ½

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

å°† `protein_tensor_to_atom14` å‡½æ•°ä¸­çš„ Python å¾ªç¯æ›¿æ¢ä¸º PyTorch å¼ é‡æ“ä½œï¼Œä»¥æå‡è½¬æ¢æ€§èƒ½å’Œ GPU å…¼å®¹æ€§ã€‚

## ğŸ” æ€§èƒ½ç“¶é¢ˆåˆ†æ

### åŸå§‹ç‰ˆæœ¬çš„ä¸»è¦ç“¶é¢ˆ

1. **æ®‹åŸºåˆ†ç»„å¾ªç¯** (235-245 è¡Œ)
   ```python
   # ğŸŒ åŸå§‹ç‰ˆæœ¬ - Python å¾ªç¯
   for i in range(num_atoms):
       res_id = (chain_ids[i].item(), residue_numbers[i].item())
       if res_id != current_res_id:
           # å¤„ç†æ®‹åŸºè¾¹ç•Œ...
   ```

2. **é“¾æ®‹åŸºè®¡æ•°å¾ªç¯** (260-268 è¡Œ)
   ```python
   # ğŸŒ åŸå§‹ç‰ˆæœ¬ - Python å¾ªç¯
   for res_idx in range(num_residues):
       start_atom = residue_starts[res_idx]
       res_chain_id = chain_ids[start_atom].item()
       # è®¡æ•°é“¾æ®‹åŸº...
   ```

3. **æ®‹åŸºç¼–å·åˆ†é…å¾ªç¯** (283-380 è¡Œ)
   ```python
   # ğŸŒ åŸå§‹ç‰ˆæœ¬ - Python å¾ªç¯
   for res_idx in range(num_residues):
       # åˆ†é…å…¨å±€ç¼–å·ã€å¤„ç†åŸå­æ˜ å°„...
   ```

## âš¡ ä¼˜åŒ–æ–¹æ¡ˆ

### 1. å‘é‡åŒ–æ®‹åŸºè¾¹ç•Œæ£€æµ‹

**ğŸš€ ä¼˜åŒ–å‰**:
```python
# Python å¾ªç¯é€ä¸ªæ£€æŸ¥åŸå­
for i in range(num_atoms):
    res_id = (chain_ids[i].item(), residue_numbers[i].item())
    if res_id != current_res_id:
        residue_starts.append(i)
```

**ğŸš€ ä¼˜åŒ–å**:
```python
# å¼ é‡æ“ä½œä¸€æ¬¡æ€§æ£€æµ‹æ‰€æœ‰è¾¹ç•Œ
max_residue_num = residue_numbers.max().item() + 1
residue_ids = chain_ids * max_residue_num + residue_numbers
padded_ids = torch.cat([residue_ids[:1] - 1, residue_ids])
changes = (padded_ids[1:] != padded_ids[:-1])
residue_starts = torch.nonzero(changes, as_tuple=True)[0]
```

**æŠ€æœ¯è¦ç‚¹**:
- åˆ›å»ºå”¯ä¸€æ®‹åŸºæ ‡è¯†ç¬¦
- ä½¿ç”¨å¼ é‡æ¯”è¾ƒæ£€æµ‹å˜åŒ–ç‚¹
- `torch.nonzero` æ‰¹é‡æ‰¾åˆ°æ‰€æœ‰è¾¹ç•Œ

### 2. å‘é‡åŒ–é“¾ä¿¡æ¯è®¡ç®—

**ğŸš€ ä¼˜åŒ–å‰**:
```python
# Python å­—å…¸å’Œå¾ªç¯
seen_chains = []
chain_residue_counts = {}
for res_idx in range(num_residues):
    res_chain_id = chain_ids[start_atom].item()
    if res_chain_id not in seen_chains:
        seen_chains.append(res_chain_id)
        chain_residue_counts[res_chain_id] = 0
    chain_residue_counts[res_chain_id] += 1
```

**ğŸš€ ä¼˜åŒ–å**:
```python
# å¼ é‡æ“ä½œæ‰¹é‡è®¡ç®—
residue_chain_ids = chain_ids[residue_starts]
unique_chains, inverse_indices = torch.unique(residue_chain_ids, return_inverse=True, sorted=True)
chain_residue_counts = torch.bincount(inverse_indices)
```

**æŠ€æœ¯è¦ç‚¹**:
- `torch.unique` æ‰¹é‡è·å–å”¯ä¸€é“¾ID
- `torch.bincount` å¿«é€Ÿè®¡ç®—æ¯æ¡é“¾çš„æ®‹åŸºæ•°é‡
- é¿å… Python å­—å…¸å’Œåˆ—è¡¨æ“ä½œ

### 3. æ‰¹é‡å¤„ç†é“¾é—´é—´éš”è®¡ç®—

**ğŸš€ ä¼˜åŒ–å‰**:
```python
# é€ä¸ªå¤„ç†æ¯æ¡é“¾
for i, chain_id in enumerate(seen_chains):
    chain_start_indices[chain_id] = current_global_index
    current_global_index += chain_residue_counts[chain_id] + CHAIN_GAP
```

**ğŸš€ ä¼˜åŒ–å**:
```python
# æ‰¹é‡è®¡ç®—æ‰€æœ‰é“¾çš„èµ·å§‹ç¼–å·
for chain_idx, chain_id in enumerate(unique_chains.tolist()):
    chain_mask = (residue_chain_ids == chain_id)
    chain_global_indices = torch.arange(start_index, start_index + chain_residue_count, device=device)
    global_residue_indices[chain_mask] = chain_global_indices
```

**æŠ€æœ¯è¦ç‚¹**:
- ä½¿ç”¨å¸ƒå°”æ©ç æ‰¹é‡åˆ†é…ç¼–å·
- `torch.arange` ç”Ÿæˆè¿ç»­ç¼–å·åºåˆ—
- å¼ é‡ç´¢å¼•é¿å…é€ä¸ªèµ‹å€¼

### 4. ä¼˜åŒ–åŸå­æ˜ å°„é€»è¾‘

**ğŸš€ ä¼˜åŒ–å‰**:
```python
# åµŒå¥—å¾ªç¯å¤„ç†æ¯ä¸ªåŸå­
for res_idx in range(num_residues):
    for atom_idx in range(start_atom, end_atom):
        atom_type_idx = atom_types[atom_idx].item()
        if atom_name in mapping:
            atom14_coords[res_idx, atom14_pos] = coordinates[atom_idx]
```

**ğŸš€ ä¼˜åŒ–å**:
```python
# æ‰¹é‡åˆ‡ç‰‡å’Œå‘é‡åŒ–èµ‹å€¼
residue_atom_types = atom_types[start_atom:end_atom]
residue_coords = coordinates[start_atom:end_atom]
for local_atom_idx, atom_type_idx in enumerate(residue_atom_types):
    # å‡å°‘äº†å†…å±‚å¾ªç¯çš„å¼€é”€
```

**æŠ€æœ¯è¦ç‚¹**:
- æ‰¹é‡åˆ‡ç‰‡å‡å°‘ç´¢å¼•å¼€é”€
- å‡å°‘ `.item()` è°ƒç”¨æ¬¡æ•°
- å‘é‡åŒ–åæ ‡èµ‹å€¼

## ğŸ“Š æ€§èƒ½æµ‹è¯•ç»“æœ

### æµ‹è¯•ç¯å¢ƒ
- **PyTorch ç‰ˆæœ¬**: 2.7.1
- **è®¾å¤‡**: CPU
- **æµ‹è¯•æ–¹æ³•**: æ¯ä¸ªåœºæ™¯è¿è¡Œ 10 æ¬¡ï¼Œè®¡ç®—å¹³å‡æ—¶é—´

### æµ‹è¯•åœºæ™¯

| åœºæ™¯åç§° | é“¾æ•° | æ¯é“¾æ®‹åŸºæ•° | æ€»åŸå­æ•° | æ€»æ®‹åŸºæ•° |
|----------|------|------------|----------|----------|
| å°å‹è›‹ç™½è´¨ | 1 | 50 | 200 | 50 |
| ä¸­å‹è›‹ç™½è´¨ | 2 | 150 | 1,200 | 300 |
| å¤§å‹è›‹ç™½è´¨ | 4 | 300 | 4,800 | 1,200 |
| å¤æ‚å¤šé“¾ | 8 | 100 | 3,200 | 800 |
| è¶…å¤§è›‹ç™½è´¨ | 2 | 1,000 | 8,000 | 2,000 |

### æ€§èƒ½å¯¹æ¯”ç»“æœ

| åœºæ™¯åç§° | åŸå§‹æ—¶é—´(s) | ä¼˜åŒ–æ—¶é—´(s) | åŠ é€Ÿæ¯” | æ€§èƒ½æå‡ |
|----------|-------------|-------------|--------|----------|
| å°å‹è›‹ç™½è´¨ | 0.0013 | 0.0009 | **1.37x** | 37.5% |
| ä¸­å‹è›‹ç™½è´¨ | 0.0083 | 0.0059 | **1.40x** | 39.9% |
| å¤§å‹è›‹ç™½è´¨ | 0.0351 | 0.0238 | **1.48x** | 47.6% |
| å¤æ‚å¤šé“¾ | 0.0220 | 0.0162 | **1.36x** | 36.0% |
| è¶…å¤§è›‹ç™½è´¨ | 0.0571 | 0.0392 | **1.46x** | 45.7% |

### ğŸ¯ ä¼˜åŒ–æ€»ç»“

- **å¹³å‡åŠ é€Ÿæ¯”**: **1.41x**
- **æœ€å¤§åŠ é€Ÿæ¯”**: **1.48x** (å¤§å‹è›‹ç™½è´¨)
- **æœ€å°åŠ é€Ÿæ¯”**: **1.36x** (å¤æ‚å¤šé“¾)
- **å¹³å‡æ€§èƒ½æå‡**: **41.3%**

### å¤„ç†é€Ÿåº¦å¯¹æ¯”

| åœºæ™¯ | åŸå§‹é€Ÿåº¦ (åŸå­/ç§’) | ä¼˜åŒ–é€Ÿåº¦ (åŸå­/ç§’) | é€Ÿåº¦æå‡ |
|------|---------------------|---------------------|----------|
| å°å‹è›‹ç™½è´¨ | 155,712 | 214,031 | +37.5% |
| ä¸­å‹è›‹ç™½è´¨ | 144,204 | 201,757 | +39.9% |
| å¤§å‹è›‹ç™½è´¨ | 136,904 | 202,011 | +47.6% |
| å¤æ‚å¤šé“¾ | 145,399 | 197,778 | +36.0% |
| è¶…å¤§è›‹ç™½è´¨ | 140,007 | 203,994 | +45.7% |

## âœ… éªŒè¯ç»“æœ

### è¾“å‡ºä¸€è‡´æ€§éªŒè¯

æ‰€æœ‰æµ‹è¯•åœºæ™¯éƒ½é€šè¿‡äº†ä¸¥æ ¼çš„è¾“å‡ºä¸€è‡´æ€§éªŒè¯ï¼š

- âœ… **åæ ‡ç²¾åº¦**: æ•°å€¼è¯¯å·® < 1e-6
- âœ… **æ©ç ä¸€è‡´**: åŸå­æ©ç å’Œæ®‹åŸºæ©ç å®Œå…¨åŒ¹é…
- âœ… **ç¼–å·æ­£ç¡®**: å…¨å±€æ®‹åŸºç¼–å·å’Œé“¾å†…ç¼–å·å®Œå…¨ä¸€è‡´
- âœ… **é“¾é—´é—´éš”**: ä¿æŒ CHAIN_GAP=200 çš„æ­£ç¡®é—´éš”

### åŠŸèƒ½å®Œæ•´æ€§

- âœ… **å¤šé“¾æ”¯æŒ**: æ­£ç¡®å¤„ç† 1-8 æ¡é“¾çš„å¤æ‚åœºæ™¯
- âœ… **é“¾é—´é—´éš”**: ä¿æŒåŸæœ‰çš„ gap=200 é€»è¾‘
- âœ… **åŸå­æ˜ å°„**: æ‰€æœ‰æ®‹åŸºç±»å‹çš„åŸå­æ˜ å°„æ­£ç¡®
- âœ… **è™šæ‹ŸåŸå­**: ç”˜æ°¨é…¸è™šæ‹Ÿ CB åŸå­è®¡ç®—æ­£å¸¸

## ğŸ”§ æŠ€æœ¯äº®ç‚¹

### 1. æ™ºèƒ½æ®‹åŸºæ ‡è¯†ç¬¦

ä½¿ç”¨æ•°å­¦æŠ€å·§åˆ›å»ºå”¯ä¸€æ®‹åŸºæ ‡è¯†ç¬¦ï¼š
```python
residue_ids = chain_ids * max_residue_num + residue_numbers
```
å°†äºŒç»´ä¿¡æ¯ `(chain_id, residue_number)` ç¼–ç ä¸ºä¸€ç»´ï¼Œä¾¿äºå‘é‡åŒ–å¤„ç†ã€‚

### 2. å¼ é‡æ©ç æŠ€æœ¯

ä½¿ç”¨å¸ƒå°”æ©ç æ‰¹é‡æ“ä½œï¼š
```python
chain_mask = (residue_chain_ids == chain_id)
global_residue_indices[chain_mask] = chain_global_indices
```
é¿å… Python å¾ªç¯ï¼Œç›´æ¥åœ¨å¼ é‡çº§åˆ«æ“ä½œã€‚

### 3. å†…å­˜ä¼˜åŒ–

- å‡å°‘ä¸­é—´å˜é‡åˆ›å»º
- æ‰¹é‡åˆ‡ç‰‡å‡å°‘ç´¢å¼•å¼€é”€
- å‘é‡åŒ–æ“ä½œå‡å°‘ Python è§£é‡Šå™¨å¼€é”€

### 4. GPU å‹å¥½è®¾è®¡

æ‰€æœ‰æ“ä½œéƒ½ä½¿ç”¨ PyTorch å¼ é‡ï¼Œå¤©ç„¶æ”¯æŒ GPU åŠ é€Ÿï¼š
- æ—  `.item()` è°ƒç”¨ï¼ˆåœ¨å…³é”®è·¯å¾„ä¸Šï¼‰
- æ‰€æœ‰è®¡ç®—ä¿æŒåœ¨è®¾å¤‡ä¸Š
- ä¸ºæœªæ¥ GPU ä¼˜åŒ–å¥ å®šåŸºç¡€

## ğŸ“ æ–‡ä»¶å˜æ›´

### æ–°å¢æ–‡ä»¶

1. **`src/protrepr/representations/atom14_converter_optimized.py`**
   - ä¼˜åŒ–ç‰ˆæœ¬çš„è½¬æ¢å™¨å®ç°
   - 4 ä¸ªæ ¸å¿ƒä¼˜åŒ–å‡½æ•°
   - å®Œæ•´çš„ç±»å‹æ³¨è§£å’Œæ–‡æ¡£

2. **`scripts/benchmark_atom14_performance.py`**
   - åŸå§‹ç‰ˆæœ¬æ€§èƒ½åŸºå‡†æµ‹è¯•
   - 5 ç§è›‹ç™½è´¨è§„æ¨¡æµ‹è¯•
   - JSON ç»“æœä¿å­˜

3. **`scripts/benchmark_optimized_performance.py`**
   - ä¼˜åŒ–ç‰ˆæœ¬æ€§èƒ½æ¯”è¾ƒæµ‹è¯•
   - è¾“å‡ºä¸€è‡´æ€§éªŒè¯
   - è¯¦ç»†çš„æ€§èƒ½åˆ†ææŠ¥å‘Š

### æµ‹è¯•ç»“æœæ–‡ä»¶

- **`benchmark_results_original.json`**: åŸå§‹ç‰ˆæœ¬åŸºçº¿æ•°æ®
- **`benchmark_results_comparison.json`**: ä¼˜åŒ–å¯¹æ¯”ç»“æœ

## ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

### çŸ­æœŸç›®æ ‡ (1å‘¨å†…)

1. **GPU åŠ é€Ÿæµ‹è¯•**
   - åœ¨ CUDA è®¾å¤‡ä¸Šè¿è¡Œæ€§èƒ½æµ‹è¯•
   - éªŒè¯ GPU åŠ é€Ÿæ•ˆæœ

2. **å†…å­˜ä½¿ç”¨ä¼˜åŒ–**
   - åˆ†æå†…å­˜ä½¿ç”¨æ¨¡å¼
   - è¿›ä¸€æ­¥å‡å°‘å†…å­˜åˆ†é…

### ä¸­æœŸç›®æ ‡ (1ä¸ªæœˆå†…)

1. **æ‰©å±•åˆ°å…¶ä»–è¡¨ç¤ºæ³•**
   - åº”ç”¨ç›¸åŒä¼˜åŒ–æŠ€æœ¯åˆ° `atom37_converter`
   - åº”ç”¨ç›¸åŒä¼˜åŒ–æŠ€æœ¯åˆ° `frame_converter`

2. **æ‰¹é‡å¤„ç†ä¼˜åŒ–**
   - æ”¯æŒå¤šä¸ªè›‹ç™½è´¨æ‰¹é‡è½¬æ¢
   - è¿›ä¸€æ­¥æå‡å¤§è§„æ¨¡å¤„ç†æ€§èƒ½

### é•¿æœŸç›®æ ‡ (3ä¸ªæœˆå†…)

1. **è‡ªåŠ¨ä¼˜åŒ–é€‰æ‹©**
   - æ ¹æ®è¾“å…¥è§„æ¨¡è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜ç®—æ³•
   - æ™ºèƒ½ç¼“å­˜å’Œé¢„è®¡ç®—

2. **åˆ†å¸ƒå¼å¤„ç†**
   - æ”¯æŒå¤š GPU å¹¶è¡Œå¤„ç†
   - å¤§è§„æ¨¡è›‹ç™½è´¨æ•°æ®åº“å¤„ç†

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡å¼ é‡ä¼˜åŒ–æ˜¾è‘—æå‡äº† Atom14 è½¬æ¢çš„æ€§èƒ½ï¼š

- **âœ… æ€§èƒ½æå‡**: å¹³å‡ 41.3% çš„é€Ÿåº¦æå‡
- **âœ… åŠŸèƒ½å®Œæ•´**: ä¿æŒæ‰€æœ‰åŸæœ‰åŠŸèƒ½ä¸å˜
- **âœ… ç²¾åº¦ä¿è¯**: æ•°å€¼ç²¾åº¦å®Œå…¨ä¸€è‡´
- **âœ… GPU å‹å¥½**: ä¸º GPU åŠ é€Ÿå¥ å®šåŸºç¡€

è¿™æ¬¡ä¼˜åŒ–ä¸ä»…æå‡äº†å½“å‰çš„æ€§èƒ½ï¼Œæ›´é‡è¦çš„æ˜¯å»ºç«‹äº†å¼ é‡ä¼˜åŒ–çš„æœ€ä½³å®è·µï¼Œä¸ºåç»­çš„ `atom37` å’Œ `frame` ä¼˜åŒ–æä¾›äº†å‚è€ƒæ¨¡æ¿ã€‚

**å…³é”®æˆæœ**: ä» ~145,000 åŸå­/ç§’ æå‡åˆ° ~200,000 åŸå­/ç§’ï¼Œä¸º ProtRepr åœ¨å¤§è§„æ¨¡è›‹ç™½è´¨å¤„ç†ä¸­çš„åº”ç”¨å¥ å®šäº†åšå®çš„æ€§èƒ½åŸºç¡€ã€‚ 